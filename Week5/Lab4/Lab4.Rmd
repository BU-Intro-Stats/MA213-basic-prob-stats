---
title: "MA213 Basic Statistics and Probability - Lab3"
bibliography: references.bib
output:
  pdf_document: default
  html_document:
    code_download: true 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
```

## Lab 4: Simulation and Probability

------------------------------------------------------------------------

## Learning Objectives

-   Validate and Explain Probability Distributions: Assess the validity of a probability distribution using the concepts of outcome, sample space, and probability properties (e.g., disjoint outcomes, probabilities between 0 and 1, and total probabilities summing to 1).

-   Compute Probabilities Using Various Tools: Use logic, Venn diagrams, and probability rules to compute probabilities for events.

-   Understand and Compute Expectations and Variances: Explain the concepts of expectations and variances of random variables, and compute the expectation and variance of a linear combination of random variables.

-   Conduct Hypothesis Testing Using Simulation: Set up null and alternative hypotheses to test for independence between variables, and use simulation techniques to evaluate data support for these hypotheses.

------------------------------------------------------------------------

## Pre-lab activities

#### Q) Let’s roll a die! You are playing a dice-rolling game and you’re curious about how this game goes at the end. The rule is you roll it once and other player roll it once and add the outcome. What can you expect from this game in the end? What is the long-term average and dispersion of the game results? In other words, what are the expected value and variance?

We let $X_1$ be the number on the top face of the first die rolled, and $X_2$ be the number on the top face of the second die rolled.

Then, what is $E(X_1 + X_2)$ and $Var(X_1 + X_2)$?

How do you justify it?

------------------------------------------------------------------------

Let's consider if we want to do $i=1, ..., 10$ . How do you want to do it?

> 1.  Rolling dice part
> 2.  Record each run
> 3.  Calculation at the end

We need three people. Two people roll the dice each time and the other person record each turn.

| i        | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   | 10  |
|----------|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| person 1 |     |     |     |     |     |     |     |     |     |     |
| person 2 |     |     |     |     |     |     |     |     |     |     |
| outcome  |     |     |     |     |     |     |     |     |     |     |

------------------------------------------------------------------------

## How do you roll each run using R?

`sample()` will randomly sample `size` many sample from the vector `x`

`sample(x, size, replace = FALSE, prob = NULL)`

```{r, echo=TRUE}
# example
x <- c("apple", "pear", "strawberry", "orange", "lemon")

sample(x, 3) # picks 3 unique fruits from the vector (without replacement)
sample(x, 10, replace=TRUE) # picks 10 fruits, allowing repeats (sampling with replacement)

```

## Loops

Loops repeatedly execute a block of code for various elements.

```{r, echo=TRUE}
# Example: Print numbers from 1 to 5
for (i in 1:5) {
  print(i)
}

# Example: Simulate rolling a die 5 times and record it
rolls <- rep(0, 5)
for (i in 1:5) {
  rolls[i] <- sample(1:6, 1)
}
rolls

```

## Function

Functions allow you to encapsulate reusable blocks of code and parameters.

```{r, echo=TRUE}
# Example: Function to calculate (a+b)^2
square <- function(a,b) {
  value = (a+b)^2
  return(value)
}
square(1,2) # Output: 9
square(2,3) # Ouptut: 25


```

## Function + Loop

Combine loops and functions for repeated tasks.

```{r, echo=TRUE}
# Example: Roll a die 3 times using a loop within a function
roll_multiple <- function(runs) {
  # rolls <- numeric(runs)
  rolls <- rep(0, runs) # create rolls vector of 0
 
   for (i in 1:runs) {
    rolls[i] <- sample(1:6, 1)
  }
  
  return(rolls)
}
roll_multiple(5)



```

## Let's roll one dice and show the output.

```{r}

#Outcome from those two dice

dice1 <- sample(1:6, 1)
dice2 <- sample(1:6, 1)

sum_of_two <- dice1 + dice2
sum_of_two


```

## Using `for loop`, assign outcome of two dice rolled into `myoutcome` from 100 iterations.

```{r}

myoutcome = rep(0, 100) # make a vector of size 100 that has all zero's

for (i in 1:100){
  dice1 <- sample(1:6, 1)
  dice2 <- sample(1:6, 1)
  sum_of_two <- dice1 + dice2
  myoutcome[i] <- sum_of_two
}

head(myoutcome) # print first 6 entries


```

## Use `replicate()`, it carries out repeated tasks in a more computationally efficient way.

```{r}

twodice_outcome <- function(){
  dice1 <- sample(1:6, 1)
  dice2 <- sample(1:6, 1)
  
  sum_of_two <- dice1 + dice2
  myoutcome <- sum_of_two
  
  return(myoutcome)
}
twodice_outcome() # this function works as one simulation run


myoutcome <- replicate(n=30, twodice_outcome()) # 10 runs
myoutcome



```

## Calculate probability of each outcome.

```{r}
myoutcome <- replicate(n=30, twodice_outcome())
outcome_table <- table(myoutcome)
n <- length(myoutcome)
prob_outcome <- outcome_table/n
prob_outcome 

# how to ensure that it is proper probability? 
sum(prob_outcome) # it needs to add up to 1

```

## Calculate the simulated expected value of the random variable.

```{r}
outcome_table * prob_outcome
names(outcome_table) # we need this
values <- as.numeric(names(outcome_table) ) 

# or
# values <- 2:12 

sum(values * prob_outcome)
mu_hat = sum(values * prob_outcome)


```

## Calculate the simulated variance of the random variable.

```{r}

sigma_2_hat <- sum( (values-mu_hat)^2 - prob_outcome  )
sigma_2_hat
```

## Make a function that has an input `n` and a list of output that gives you the simulated expected value and variance.

```{r}

sim_fn <- function(n=1000){
 myoutcome = rep(0, n)

  for (i in 1:n){
    dice1 <- sample(1:6, 1)
    dice2 <- sample(1:6, 1)
    sum_of_two <- dice1 + dice2
    myoutcome[i] <- sum_of_two
  }
  factored_outcome <- factor(myoutcome)
  outcome_table <- table(factored_outcome)
  
  prob_outcome <- outcome_table/n

  values <- as.numeric(names(outcome_table) ) 


  mu_hat = sum(values * prob_outcome)
  sigma_2_hat <- sum( (values-mu_hat)^2 - prob_outcome  )
 
  output <- list(mu = mu_hat, sigma2 = sigma_2_hat)
  return(output)
}


sim_fn(100)

sim_fn(1000)

sim_fn(10000)

sim_fn(100000)
```

## Hypothesis Testing Using Simulation

Aspirin and Myocardial Infarction Example.

The data shows effectiveness of Aspirin in preventing death after a myocardial infarct.

In the study, 1,360 patients who had already suffered a stroke were randomly allocated to receive either a daily low-dose aspirin treatment or a placebo. The table shows the number of deaths resulting from myocardial infarction over an approximately three-year follow-up period. The data is based on @salt1991swedish.

``` r

          Yes   No    Total
Placebo   28    656   684
Aspirin   18    658   676
```

## What are the null hypothesis and alternative hypothesis in this study?

Based on the data, `18/676 = 2.6%` who took aspirin died due to myocardial infarct while `28/684 = 4%` who took a placebo died due to myocardial infarct.

$H_0$ : The treatment and the outcome are independent. They have no relationship and the observed difference between the proportion of patients who died due to myocardial infarct in the two groups, 1.4% was due to chance.

$H_a$ : The treatment and the outcome are independent. The difference between the proportion of patients who died due to myocardial infarct in the two groups, 1.4% was not due to chance and aspirin was effective.

## How to simulate them?

We take 28+18 "yes" and 656+658 "no" as the total

```{r, echo=TRUE}
data <- c(rep("yes", 46), rep("no", 1314))
head(data)
```

Randomly take 684 of them as "Placebo" and 676 of them as "Aspirin".

```{r, echo=TRUE}
index <- sample(1:length(data), 684) # this is where we allocate patients regardless of cause of deaths (that means it is under the null hypothesis data)

Placebo <- data[index]
Aspirin <- data[-index]
```

Getting the contingency table

```{r, echo=TRUE}
group <- c(rep("Placebo", length(Placebo)), rep("Aspirin", length(Aspirin)))
outcome <- c(Placebo, Aspirin)
df <- data.frame(Group = group, Outcome = outcome)
df_table <- table(df)
df_table
```

Get the ratio difference

```{r, echo=TRUE}
ratio1 = df_table[3] / 684
ratio2 = df_table[4] / 676
ratio2-ratio1
```

Simulate them 100 times

```{r, echo=TRUE}
sim_function<-function(){
  index <- sample(1:1360, 684)
  Placebo <- data[index]
  Aspirin <- data[-index]
  group <- c(rep("Placebo", length(Placebo)), rep("Aspirin", length(Aspirin)))
  outcome <- c(Placebo, Aspirin)
  df <- data.frame(Group = group, Outcome = outcome)
  
  df_table <- table(df)
  ratio1 = df_table[3] / 684
  ratio2 = df_table[4] / 676

  out <- ratio2-ratio1
  
  
  return(out)
}

sim_function()
```

```{r, echo=TRUE}
library(ggplot2)
rates <- rep(0,100)

for (i in 1:100){
  rates[i] <- sim_function()
}
sim_df <- data.frame(Difference_prop=rates)
ggplot(data=sim_df, aes(x=Difference_prop)) + geom_dotplot()


```

Based on the simulation results, we do not reject the null hypothesis that the treatment (aspirin vs. placebo) has no significant effect on the proportion of deaths due to myocardial infarction. The simulated differences in death rates between the two groups were consistent with chance variability observed in the study. Therefore, the evidence does not support the claim that aspirin is effective in reducing mortality from myocardial infarction.

## Lab activities

## This time, you invented another challenging game now. If one person roll a dice, then the outcome is multiplied by 3. Also when second person roll a dice, then the outcome is multiplied by 4. The final outcome is the sum of those two values. What is the expected value and variance of the random variable?

Q. What is the expected value of the total outcome?

Q. Let's simulate it. Make a function to obtain one output from this setting.

```{r}

#
#



```

Q. Using the function above, Make an another function to obtain the expected value from $n$ iteration.

```{r}
#
#
#
```

Q. Using the function above, could you make a plot with the x-axis is `n` and the y-axis representing the expected value of the outcome?

```{r}
#
#
#

```

Q. What is the expected value of one die? And variance of one die? ($E(X)$ and $Var(X)$)? Compare your answers to $3E( X_1) + 4E( X_2)$. Also, What is $Var(3X_1 + 4 X_2)$?

------------------------------------------------------------------------

## Post-lab activities

Please name your submission as `lab4.R`

Now, You flip a slightly biased coin where $P(head)=0.49$ and $P(tail)=0.51$. If the result is head, you are given \$10, otherwise you pay \$20. How much money you have at the end?

1.  Calculate theoretical value of $\mu$ and $\sigma^2$. Assign them into `mu` and `sigma_2`, respectively.
2.  You are going to make an function named `my_sim` which takes input of `n` and gives an output list of `mu` and `sigma_2` .

for example

``` r
my_sim(10)
$mu
[1] 7.44

$sigma2
[1] 111.1296

# and it is expected that
>out <- my_sim(100)
>out$mu
[1] 7.44
>out$sigma2
[1] 111.1296
```

3.  (Optional with extra credit)

To do this, you include `Optional=TRUE` in your file.

The table below summarizes the survival outcomes from the Titanic disaster based on gender.

``` r
          Survived
          Yes   No    Total
female    307   156   463
male      142   708   850
```

We want to simulate the null hypothesis where we pretend that the gender of the passenger and survival are independent.

Create the **`sim_function()`** for one simulation run to calculate the difference in the proportion of survival between females and males.

Obtain 100 simulation runs to calculate the difference rates and assign them to **`rates`**.

Would you reject the null hypothesis or not? Include `Reject_H_not = TRUE` or `Reject_H_not = FALSE`
